{% extends 'base.html' %}
{% load static %}

{% block title %}Zevk Profilim - MekanKeşif{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages.css' %}">
<style>
.taste-profile-page {
    max-width: 1000px;
    margin: 0 auto;
    padding: 40px 20px;
    min-height: 80vh;
}

.taste-profile-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
}

.taste-profile-header h1 {
    font-size: 32px;
    font-weight: 700;
    color: #111;
    margin-bottom: 12px;
}

.taste-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    text-align: center;
}

.taste-card h3 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: var(--spacing-md);
}

.taste-card p {
    font-size: 18px;
    opacity: 0.9;
}

.taste-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #e5e5e5;
}

.taste-section h5 {
    color: #667eea;
    margin-bottom: var(--spacing-lg);
    font-weight: 600;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.progress-custom {
    height: 28px;
    border-radius: var(--radius-sm);
    background: #f0f0f0;
    overflow: hidden;
    margin-bottom: var(--spacing-md);
}

.progress-bar-custom {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 13px;
    transition: width 0.5s ease;
}

.stat-item {
    text-align: center;
    padding: 24px;
    background: #f8f9fa;
    border-radius: 12px;
    margin-bottom: 16px;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #667eea;
    display: block;
}

.stat-label {
    color: #666;
    font-size: 14px;
    margin-top: 8px;
    display: block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 30px;
}

.progress-item {
    margin-bottom: 16px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xs);
}

.progress-label {
    font-weight: 600;
    color: #111;
}

.progress-percent {
    color: #666;
    font-size: 14px;
}

.progress-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
}

.empty-state {
    text-align: center;
    padding: 60px 40px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #e5e5e5;
}

.empty-state-icon {
    font-size: 64px;
    color: #ccc;
    margin-bottom: 24px;
}

.empty-state h4 {
    color: #111;
    margin-bottom: 16px;
    font-size: 24px;
}

.empty-state p {
    color: #666;
    margin-bottom: 30px;
    font-size: 16px;
}

.empty-progress {
    height: 30px;
    border-radius: 8px;
    background: #f0f0f0;
    overflow: hidden;
    margin-bottom: 30px;
}

.empty-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
}

.alert {
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.alert-info {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #90caf9;
}

.alert-danger {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef5350;
}

.alert-warning {
    background: #fff3e0;
    color: #e65100;
    border: 1px solid #ffb74d;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    font-size: 14px;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
    transform: translateY(-1px);
}

.btn-outline-primary {
    background: transparent;
    color: #667eea;
    border: 2px solid #667eea;
}

.btn-outline-primary:hover {
    background: #667eea;
    color: white;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-container {
    text-align: center;
    padding: 60px 40px;
}

.loading-container p {
    margin-top: 16px;
    color: #666;
}
</style>
{% endblock %}

{% block content %}
<div class="taste-profile-page">
    <div class="taste-profile-header">
        <h1>
            <i class="bi bi-palette"></i> Zevk Profilim
        </h1>
    </div>
    
    <div id="tasteProfileContainer">
        <div class="loading-container">
            <div class="spinner"></div>
            <p style="margin-top: 16px; color: #666;">Yükleniyor...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTasteProfile();
});

async function loadTasteProfile() {
    const container = document.getElementById('tasteProfileContainer');
    
    try {
        const response = await fetch('/api/users/me/taste-profile/', {
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const data = await response.json();
        
        if (data.success && data.has_enough_data) {
            container.innerHTML = buildTasteProfileHTML(data);
            animateProgressBars();
        } else {
            container.innerHTML = buildEmptyStateHTML(data);
        }
    } catch (error) {
        console.error('Error loading taste profile:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 
                Zevk profili yüklenirken bir hata oluştu.
            </div>
        `;
    }
}

function buildTasteProfileHTML(data) {
    let html = `
        <div class="taste-card">
            <h3><i class="bi bi-stars"></i> ${data.style_label || 'Zevk Profili'}</h3>
            <p>Sen ${(data.style_label || 'özel').toLowerCase()} mekan seven birisin.</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-value">${data.interaction_count || 0}</span>
                <span class="stat-label">Toplam Etkileşim</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${Object.keys(data.category_weights || {}).length}</span>
                <span class="stat-label">Favori Kategori</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${Object.keys(data.atmosphere_weights || {}).length}</span>
                <span class="stat-label">Atmosfer Tercihi</span>
            </div>
        </div>
    `;
    
    // Kategori dağılımı
    if (data.category_weights && Object.keys(data.category_weights).length > 0) {
        const categories = Object.entries(data.category_weights)
            .sort((a, b) => b[1] - a[1]);
        
        html += `
            <div class="taste-section">
                <h5><i class="bi bi-tags"></i> Kategori Tercihlerin</h5>
                ${categories.map(([cat, weight]) => {
                    const percent = Math.round(weight * 100);
                    return `
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">${getCategoryLabel(cat)}</span>
                                <span class="progress-percent">%${percent}</span>
                            </div>
                            <div class="progress-custom">
                                <div class="progress-bar-custom" style="width: ${percent}%">
                                    ${percent}%
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    // Atmosfer tercihleri
    if (data.atmosphere_weights && Object.keys(data.atmosphere_weights).length > 0) {
        const atmospheres = Object.entries(data.atmosphere_weights)
            .sort((a, b) => b[1] - a[1]);
        
        html += `
            <div class="taste-section">
                <h5><i class="bi bi-cloud"></i> Atmosfer Tercihlerin</h5>
                <div class="progress-grid">
                    ${atmospheres.map(([atm, weight]) => {
                        const percent = Math.round(weight * 100);
                        return `
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">${atm}</span>
                                    <span class="progress-percent">%${percent}</span>
                                </div>
                                <div class="progress-custom">
                                    <div class="progress-bar-custom" style="width: ${percent}%">
                                        ${percent}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Context tercihleri
    if (data.context_weights && Object.keys(data.context_weights).length > 0) {
        const contexts = Object.entries(data.context_weights)
            .sort((a, b) => b[1] - a[1]);
        
        const contextLabels = {
            'arkadaş': 'Arkadaşlarla',
            'dost': 'Arkadaşlarla',
            'sevgili': 'Sevgiliyle',
            'aile': 'Aileyle',
            'tek': 'Tek Başına',
            'is': 'İş İçin'
        };
        
        html += `
            <div class="taste-section">
                <h5><i class="bi bi-people"></i> Kiminle Gidilir?</h5>
                <p style="color: #666; margin-bottom: 16px;">
                    Daha çok ${contexts.map(([ctx, weight]) => {
                        const label = contextLabels[ctx] || ctx;
                        const percent = Math.round(weight * 100);
                        return `${label.toLowerCase()} (%${percent})`;
                    }).slice(0, 3).join(', ')} mekanları beğeniyorsun.
                </p>
                <div class="progress-grid">
                    ${contexts.map(([ctx, weight]) => {
                        const label = contextLabels[ctx] || ctx;
                        const percent = Math.round(weight * 100);
                        return `
                            <div class="progress-item">
                                <div class="progress-header">
                                    <span class="progress-label">${label}</span>
                                    <span class="progress-percent">%${percent}</span>
                                </div>
                                <div class="progress-custom">
                                    <div class="progress-bar-custom" style="width: ${percent}%">
                                        ${percent}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            <div style="flex: 1;">
                <strong>Not:</strong> Yeni mekanlar beğendikçe zevk profilin otomatik olarak yenilenecek.
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="recalculateProfile()">
                <i class="bi bi-arrow-clockwise"></i> Şimdi Güncelle
            </button>
        </div>
    `;
    
    return html;
}

function buildEmptyStateHTML(data) {
    const progress = Math.min(100, ((data.interaction_count || 0) / (data.min_interactions || 5)) * 100);
    
    return `
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-palette"></i>
            </div>
            <h4>Zevk Profili Henüz Oluşturulamadı</h4>
            <p>
                ${data.message || 'Zevk profilini çıkarabilmemiz için birkaç mekan beğenmen gerekiyor.'}
            </p>
            <div class="empty-progress" style="margin-bottom: var(--spacing-lg);">
                <div class="empty-progress-bar" style="width: ${progress}%">
                    ${data.interaction_count || 0} / ${data.min_interactions || 5}
                </div>
            </div>
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                <a href="{% url 'places:discover_swipe' %}" class="btn btn-primary">
                    <i class="bi bi-arrow-left-right"></i> Swipe ile Keşfet
                </a>
                <a href="{% url 'places:discover' %}" class="btn btn-outline-primary">
                    <i class="bi bi-compass"></i> Keşfet
                </a>
            </div>
        </div>
    `;
}

function getCategoryLabel(cat) {
    const labels = {
        'kafe': 'Kafe',
        'coffee': 'Kahve',
        'restoran': 'Restoran',
        'restaurant': 'Restoran',
        'bar': 'Bar',
        'brunch': 'Brunch',
        'tatlı': 'Tatlı',
        'dessert': 'Tatlı'
    };
    return labels[cat] || cat.charAt(0).toUpperCase() + cat.slice(1);
}

function animateProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar-custom');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 100);
    });
}

async function recalculateProfile() {
    const container = document.getElementById('tasteProfileContainer');
    container.innerHTML = '<div class="loading-container"><div class="spinner"></div><p>Yeniden hesaplanıyor...</p></div>';
    
    try {
        const response = await fetch('/api/users/me/taste-profile/recalculate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const data = await response.json();
        
        if (data.success) {
            loadTasteProfile();
        } else {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    ${data.message || 'Yeniden hesaplama başarısız oldu.'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error recalculating:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Bir hata oluştu. Lütfen tekrar deneyin.
            </div>
        `;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
