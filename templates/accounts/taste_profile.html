{% extends 'base.html' %}

{% block title %}Zevk Profilim - MekanKeşif{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <h2 class="mb-4">
                <i class="bi bi-palette"></i> Zevk Profilim
            </h2>
            
            <div id="tasteProfileContainer">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.taste-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.taste-card h3 {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
}

.taste-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.taste-section h5 {
    color: #667eea;
    margin-bottom: 20px;
    font-weight: 600;
}

.progress-custom {
    height: 25px;
    border-radius: 12px;
    background: #f0f0f0;
    overflow: hidden;
}

.progress-bar-custom {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    transition: width 0.5s ease;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 15px;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #667eea;
}

.stat-label {
    color: #666;
    font-size: 14px;
    margin-top: 5px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTasteProfile();
});

async function loadTasteProfile() {
    const container = document.getElementById('tasteProfileContainer');
    
    try {
        const response = await fetch('/api/users/me/taste-profile/', {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success && data.has_enough_data) {
            container.innerHTML = buildTasteProfileHTML(data);
        } else {
            container.innerHTML = buildEmptyStateHTML(data);
        }
    } catch (error) {
        console.error('Error loading taste profile:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Zevk profili yüklenirken bir hata oluştu.
            </div>
        `;
    }
}

function buildTasteProfileHTML(data) {
    let html = `
        <div class="taste-card text-center">
            <h3><i class="bi bi-stars"></i> ${data.style_label}</h3>
            <p class="lead mb-0">Sen ${data.style_label.toLowerCase()} mekan seven birisin.</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-value">${data.interaction_count}</div>
                    <div class="stat-label">Toplam Etkileşim</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-value">${Object.keys(data.category_weights || {}).length}</div>
                    <div class="stat-label">Favori Kategori</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-value">${Object.keys(data.atmosphere_weights || {}).length}</div>
                    <div class="stat-label">Atmosfer Tercihi</div>
                </div>
            </div>
        </div>
    `;
    
    // Kategori dağılımı
    if (data.category_weights && Object.keys(data.category_weights).length > 0) {
        const categories = Object.entries(data.category_weights)
            .sort((a, b) => b[1] - a[1]);
        
        html += `
            <div class="taste-section">
                <h5><i class="bi bi-tags"></i> Kategori Tercihlerin</h5>
                ${categories.map(([cat, weight]) => {
                    const percent = Math.round(weight * 100);
                    return `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold">${getCategoryLabel(cat)}</span>
                                <span class="text-muted">%${percent}</span>
                            </div>
                            <div class="progress-custom">
                                <div class="progress-bar-custom" style="width: ${percent}%">
                                    ${percent}%
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    // Atmosfer tercihleri
    if (data.atmosphere_weights && Object.keys(data.atmosphere_weights).length > 0) {
        const atmospheres = Object.entries(data.atmosphere_weights)
            .sort((a, b) => b[1] - a[1]);
        
        html += `
            <div class="taste-section">
                <h5><i class="bi bi-cloud"></i> Atmosfer Tercihlerin</h5>
                <div class="row">
                    ${atmospheres.map(([atm, weight]) => {
                        const percent = Math.round(weight * 100);
                        return `
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">${atm}</span>
                                    <span class="text-muted">%${percent}</span>
                                </div>
                                <div class="progress-custom">
                                    <div class="progress-bar-custom" style="width: ${percent}%">
                                        ${percent}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Context tercihleri
    if (data.context_weights && Object.keys(data.context_weights).length > 0) {
        const contexts = Object.entries(data.context_weights)
            .sort((a, b) => b[1] - a[1]);
        
        const contextLabels = {
            'arkadaş': 'Arkadaşlarla',
            'dost': 'Arkadaşlarla',
            'sevgili': 'Sevgiliyle',
            'aile': 'Aileyle',
            'tek': 'Tek Başına',
            'is': 'İş İçin'
        };
        
        html += `
            <div class="taste-section">
                <h5><i class="bi bi-people"></i> Kiminle Gidilir?</h5>
                <p class="text-muted mb-3">Daha çok ${contexts.map(([ctx, weight]) => {
                    const label = contextLabels[ctx] || ctx;
                    const percent = Math.round(weight * 100);
                    return `${label.toLowerCase()} (%${percent})`;
                }).slice(0, 3).join(', ')} mekanları beğeniyorsun.</p>
                <div class="row">
                    ${contexts.map(([ctx, weight]) => {
                        const label = contextLabels[ctx] || ctx;
                        const percent = Math.round(weight * 100);
                        return `
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">${label}</span>
                                    <span class="text-muted">%${percent}</span>
                                </div>
                                <div class="progress-custom">
                                    <div class="progress-bar-custom" style="width: ${percent}%">
                                        ${percent}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            <strong>Not:</strong> Yeni mekanlar beğendikçe zevk profilin otomatik olarak yenilenecek.
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="recalculateProfile()">
                <i class="bi bi-arrow-clockwise"></i> Şimdi Güncelle
            </button>
        </div>
    `;
    
    return html;
}

function buildEmptyStateHTML(data) {
    return `
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-palette" style="font-size: 64px; color: #ccc;"></i>
                <h4 class="mt-3">Zevk Profili Henüz Oluşturulamadı</h4>
                <p class="text-muted mb-4">
                    ${data.message || 'Zevk profilini çıkarabilmemiz için birkaç mekan beğenmen gerekiyor.'}
                </p>
                <div class="mb-3">
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${Math.min(100, (data.interaction_count || 0) / (data.min_interactions || 5) * 100)}%">
                            ${data.interaction_count || 0} / ${data.min_interactions || 5}
                        </div>
                    </div>
                </div>
                <div>
                    <a href="{% url 'places:discover_swipe' %}" class="btn btn-primary me-2">
                        <i class="bi bi-arrow-left-right"></i> Swipe ile Keşfet
                    </a>
                    <a href="{% url 'places:discover' %}" class="btn btn-outline-primary">
                        <i class="bi bi-compass"></i> Keşfet
                    </a>
                </div>
            </div>
        </div>
    `;
}

function getCategoryLabel(cat) {
    const labels = {
        'kafe': 'Kafe',
        'coffee': 'Kahve',
        'restoran': 'Restoran',
        'restaurant': 'Restoran',
        'bar': 'Bar',
        'brunch': 'Brunch',
        'tatlı': 'Tatlı',
        'dessert': 'Tatlı'
    };
    return labels[cat] || cat.charAt(0).toUpperCase() + cat.slice(1);
}

async function recalculateProfile() {
    const container = document.getElementById('tasteProfileContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Yeniden hesaplanıyor...</p></div>';
    
    try {
        const response = await fetch('/api/users/me/taste-profile/recalculate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Profili yeniden yükle
            loadTasteProfile();
        } else {
            container.innerHTML = `
                <div class="alert alert-warning">
                    ${data.message || 'Yeniden hesaplama başarısız oldu.'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error recalculating:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                Bir hata oluştu. Lütfen tekrar deneyin.
            </div>
        `;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
