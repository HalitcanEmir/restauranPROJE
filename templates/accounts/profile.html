{% extends 'base.html' %}

{% block title %}{{ profile_user.username }} - Profil{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                {% if profile_user.profile.avatar %}
                    <img src="{{ profile_user.profile.avatar.url }}" class="rounded-circle mb-3" width="150" height="150" alt="Avatar">
                {% else %}
                    <i class="bi bi-person-circle" style="font-size: 150px;"></i>
                {% endif %}
                <h4>{{ profile_user.profile.get_display_name }}</h4>
                <p class="text-muted">@{{ profile_user.username }}</p>
                
                {% if profile_user.profile.city %}
                    <p><i class="bi bi-geo-alt"></i> {{ profile_user.profile.city }}</p>
                {% endif %}
                
                {% if profile_user.profile.bio %}
                    <p>{{ profile_user.profile.bio }}</p>
                {% endif %}
                
                {% if is_own_profile %}
                <a href="{% url 'accounts:profile_edit' %}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Profili Düzenle
                </a>
                {% endif %}
            </div>
        </div>
        
        {% if profile_user.profile.favorite_categories %}
        <div class="card mt-3">
            <div class="card-header">
                <h5>Favori Kategoriler</h5>
            </div>
            <div class="card-body">
                {% for cat in profile_user.profile.favorite_categories %}
                    <span class="badge bg-primary">{{ cat }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Taste Profile Card -->
        <div class="card mt-3" id="tasteProfileCard">
            <div class="card-header">
                <h5><i class="bi bi-palette"></i> Zevk Profili</h5>
            </div>
            <div class="card-body" id="tasteProfileContent">
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar-check"></i> Gittiğim Yerler</h5>
            </div>
            <div class="card-body">
                {% if visits %}
                    {% for visit in visits %}
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6>
                                    <a href="{% url 'places:place_detail' visit.place.id %}" class="text-decoration-none">
                                        {{ visit.place.name }}
                                    </a>
                                </h6>
                                <small class="text-muted">{{ visit.visited_at|date:"d M Y" }}</small>
                            </div>
                            {% if visit.sentiment %}
                            <span class="badge bg-primary ms-2">
                                {{ visit.get_sentiment_display }}
                            </span>
                            {% endif %}
                        </div>
                        
                        {% if visit.rating %}
                        <div class="mb-2">
                            <span class="rating-stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= visit.rating %}
                                        <i class="bi bi-star-fill"></i>
                                    {% else %}
                                        <i class="bi bi-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <small class="text-muted ms-2">{{ visit.rating }}/5</small>
                        </div>
                        {% endif %}
                        
                        {% if visit.tags %}
                        <div class="mb-2">
                            {% for tag in visit.tags %}
                                <span class="badge bg-info">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if visit.suitable_for %}
                        <div class="mb-2">
                            <small class="text-muted">Kiminle:</small>
                            {% for suitable in visit.suitable_for %}
                                <span class="badge bg-secondary">{{ suitable }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if visit.atmosphere %}
                        <div class="mb-2">
                            <small class="text-muted">Ortam:</small>
                            {% for atm in visit.atmosphere %}
                                <span class="badge bg-success">{{ atm }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if visit.comment %}
                        <p class="mb-2 mt-2">{{ visit.comment|truncatewords:30 }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Henüz ziyaret kaydedilmemiş.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTasteProfile();
});

async function loadTasteProfile() {
    const content = document.getElementById('tasteProfileContent');
    
    try {
        const response = await fetch('/api/users/me/taste-profile/', {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success && data.has_enough_data) {
            // Taste profile var, göster
            content.innerHTML = buildTasteProfileHTML(data);
        } else {
            // Yeterli veri yok
            content.innerHTML = `
                <div class="text-center">
                    <p class="text-muted mb-2">
                        <i class="bi bi-info-circle"></i> ${data.message || 'Zevk profilini çıkarabilmemiz için birkaç mekan beğenmen gerekiyor.'}
                    </p>
                    <small class="text-muted">
                        Şu an <strong>${data.interaction_count || 0}</strong> etkileşimin var. 
                        En az <strong>${data.min_interactions || 5}</strong> mekanla etkileşime geç.
                    </small>
                    <div class="mt-3">
                        <a href="{% url 'places:discover_swipe' %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-compass"></i> Keşfet
                        </a>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading taste profile:', error);
        content.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Zevk profili yüklenirken bir hata oluştu.
            </div>
        `;
    }
}

function buildTasteProfileHTML(data) {
    // Style label
    let html = `
        <div class="mb-3">
            <h6 class="text-primary">
                <i class="bi bi-stars"></i> ${data.style_label}
            </h6>
            <p class="text-muted small mb-0">
                Sen ${data.style_label.toLowerCase()} mekan seven birisin.
            </p>
        </div>
    `;
    
    // Context özeti
    if (data.context_weights && Object.keys(data.context_weights).length > 0) {
        const topContexts = Object.entries(data.context_weights)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);
        
        const contextLabels = {
            'arkadaş': 'arkadaşlarınla',
            'dost': 'arkadaşlarınla',
            'sevgili': 'sevgiliyle',
            'aile': 'aileyle',
            'tek': 'tek başına',
            'is': 'iş için'
        };
        
        const contextText = topContexts.map(([ctx, weight]) => {
            const label = contextLabels[ctx] || ctx;
            const percent = Math.round(weight * 100);
            return `${label} (%${percent})`;
        }).join(', ');
        
        html += `
            <div class="mb-3">
                <small class="text-muted d-block mb-1">Kiminle gidilir:</small>
                <p class="mb-0 small">${contextText}</p>
            </div>
        `;
    }
    
    // Atmosfer özeti
    if (data.atmosphere_weights && Object.keys(data.atmosphere_weights).length > 0) {
        const topAtmospheres = Object.entries(data.atmosphere_weights)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([atm, _]) => atm);
        
        html += `
            <div class="mb-3">
                <small class="text-muted d-block mb-1">Atmosfer tercihlerin:</small>
                <div>
                    ${topAtmospheres.map(atm => 
                        `<span class="badge bg-info me-1">${atm}</span>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    // Kategori dağılımı (progress bar)
    if (data.category_weights && Object.keys(data.category_weights).length > 0) {
        const topCategories = Object.entries(data.category_weights)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        html += `
            <div class="mb-2">
                <small class="text-muted d-block mb-2">Kategori tercihlerin:</small>
                ${topCategories.map(([cat, weight]) => {
                    const percent = Math.round(weight * 100);
                    return `
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small>${cat}</small>
                                <small class="text-muted">%${percent}</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar" role="progressbar" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    html += `
        <div class="mt-3 pt-3 border-top">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i> 
                Yeni mekanlar beğendikçe zevk profilin yenilenecek.
            </small>
        </div>
    `;
    
    return html;
}
</script>
{% endblock %}
