{% extends 'base.html' %}
{% load static %}

{% block title %}Favorilerim - MekanKeşif{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages.css' %}">
{% endblock %}

{% block content %}
<div class="discover-page">
    <div class="container" style="max-width: 1280px;">
    <h2 class="mb-4">
        <i class="bi bi-heart"></i> Favorilerim
    </h2>
    
        <h1 style="margin-bottom: var(--spacing-xl);">
            <i class="bi bi-heart-fill" style="color: var(--error);"></i> Favorilerim
        </h1>
        
        <div class="tabs" data-component="tabs">
            <ul class="tab-list">
                <li>
                    <button class="tab active" data-tab="liked">
                        <i class="bi bi-heart-fill"></i> Beğendiklerim
                    </button>
                </li>
                <li>
                    <button class="tab" data-tab="saved">
                        <i class="bi bi-bookmark-fill"></i> Kaydettiklerim
                    </button>
                </li>
                <li>
                    <button class="tab" data-tab="disliked">
                        <i class="bi bi-x-circle"></i> Beğenmediklerim
                    </button>
                </li>
            </ul>
            
            <div class="tab-panel active" data-tab-panel="liked">
                <div id="likedPlaces" class="places-grid">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Yükleniyor...</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-panel" data-tab-panel="saved">
                <div id="savedPlaces" class="places-grid">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Yükleniyor...</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-panel" data-tab-panel="disliked">
                <div id="dislikedPlaces" class="places-grid">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Yükleniyor...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadFavorites('like', 'likedPlaces');
    
    // Tab değiştiğinde ilgili listeyi yükle
    document.querySelector('[data-tab="liked"]').addEventListener('click', function() {
        loadFavorites('like', 'likedPlaces');
    });
    document.querySelector('[data-tab="saved"]').addEventListener('click', function() {
        loadFavorites('save', 'savedPlaces');
    });
    document.querySelector('[data-tab="disliked"]').addEventListener('click', function() {
        loadFavorites('dislike', 'dislikedPlaces');
    });
});

async function loadFavorites(action, containerId) {
    const container = document.getElementById(containerId);
    
    try {
        const response = await fetch(`/api/places/discover/preferences/?action=${action}`, {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success && data.places.length > 0) {
            container.innerHTML = data.places.map(place => createPlaceCard(place)).join('');
            
            // Add animations
            container.querySelectorAll('.place-card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('animate-slide-up');
            });
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>Henüz ${getActionLabel(action)} yok.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading favorites:', error);
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle"></i> Bir hata oluştu.
                </div>
            </div>
        `;
    }
}

function createPlaceCard(place) {
    const photo = place.first_photo || place.photos?.[0] || null;
    const rating = place.average_rating || 0;
    const ratingStars = Array.from({length: 5}, (_, i) => 
        i < Math.floor(rating) 
            ? '<i class="bi bi-star-fill"></i>' 
            : '<i class="bi bi-star"></i>'
    ).join('');
    
    return `
        <div class="place-card" data-component="card">
            ${photo ? `
                <div class="place-card-image" style="background-image: url('${photo}')">
                    <div class="place-card-overlay"></div>
                </div>
            ` : `
                <div class="place-card-image">
                    <i class="bi bi-cup-hot"></i>
                </div>
            `}
            <div class="place-card-body">
                <h3 class="place-card-title">
                    <a href="/places/${place.id}/">${escapeHtml(place.name)}</a>
                </h3>
                <p class="place-card-location">
                    <i class="bi bi-geo-alt"></i> ${escapeHtml(place.city || '')}
                </p>
                ${place.short_description ? `
                    <p class="place-card-description">${escapeHtml(place.short_description.substring(0, 100))}...</p>
                ` : ''}
                <div class="place-card-rating">
                    <div class="stars">${ratingStars}</div>
                    ${rating > 0 ? `<span class="rating-value">${rating.toFixed(1)}</span>` : ''}
                </div>
                ${place.featured_features && place.featured_features.length > 0 ? `
                    <div class="place-card-tags">
                        ${place.featured_features.slice(0, 3).map(f => 
                            `<span class="tag">${escapeHtml(f)}</span>`
                        ).join('')}
                    </div>
                ` : ''}
                <div class="place-card-footer">
                    <span class="place-price">${place.price_level || '₺₺'}</span>
                    <a href="/places/${place.id}/" class="btn btn-primary btn-sm">
                        Detay <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getActionLabel(action) {
    const labels = {
        'like': 'beğendiğiniz mekan',
        'save': 'kaydettiğiniz mekan',
        'dislike': 'beğenmediğiniz mekan'
    };
    return labels[action] || 'mekan';
}
</script>
{% endblock %}
