{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Swipe Keşfet - MekanKeşif{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-dark: #1a1a1a;
    --secondary-dark: #2d2d2d;
    --accent: #d4af37;
    --text-light: #f5f5f5;
    --text-muted: #a0a0a0;
    --like-color: #4ade80;
    --nope-color: #f87171;
    --save-color: #60a5fa;
}

body {
    background: var(--primary-dark);
    color: var(--text-light);
    overflow: hidden;
    margin: 0;
    padding: 0;
}

/* Hide navbar on swipe page */
.navbar {
    display: none;
}

.swipe-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin: 0;
    overflow: hidden;
}

.cards-stack {
    position: relative;
    width: 100%;
    height: 100%;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.swipe-card {
    position: absolute;
    width: 100%;
    height: 100%;
    background: var(--secondary-dark);
    border-radius: 0;
    overflow-y: auto;
    overflow-x: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    cursor: grab;
    transition: transform 0.3s ease, opacity 0.3s ease;
    will-change: transform;
}

.swipe-card:active {
    cursor: grabbing;
}

.swipe-card.swiping {
    transition: none;
}

.card-hero-image {
    width: 100%;
    height: 50vh;
    min-height: 400px;
    object-fit: cover;
    position: relative;
}

.card-hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.8) 100%);
}

.card-header {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 30px;
    color: white;
    z-index: 2;
}

.card-name {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
}

.card-category {
    font-size: 16px;
    color: var(--text-muted);
    margin-bottom: 5px;
}

.card-slogan {
    font-size: 14px;
    color: var(--text-muted);
    font-style: italic;
}

.card-content {
    padding: 30px;
    min-height: 50vh;
    background: var(--secondary-dark);
}

.card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
}

.card-tag {
    background: rgba(212, 175, 55, 0.2);
    color: var(--accent);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    border: 1px solid var(--accent);
}

.card-features {
    margin: 20px 0;
}

.card-feature {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
}

.card-feature-icon {
    font-size: 20px;
    margin-right: 15px;
    color: var(--accent);
    min-width: 30px;
}

.card-feature-text {
    flex: 1;
}

.card-feature-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--text-light);
}

.card-feature-desc {
    font-size: 13px;
    color: var(--text-muted);
}

.card-menu {
    margin: 20px 0;
    padding: 20px;
    background: rgba(255,255,255,0.03);
    border-radius: 15px;
}

.card-menu-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    color: var(--accent);
}

.card-menu-items {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
}

.card-menu-item {
    text-align: center;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    transition: transform 0.2s ease, background 0.2s ease;
}

.card-menu-item:hover {
    transform: scale(1.05);
    background: rgba(255,255,255,0.1);
}

.card-menu-item-name {
    font-size: 12px;
    margin-bottom: 5px;
    color: var(--text-light);
}

.card-menu-item-price {
    font-size: 16px;
    font-weight: bold;
    color: var(--accent);
}

/* Overlay indicators */
.overlay-like, .overlay-nope, .overlay-save {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-20deg);
    font-size: 120px;
    font-weight: bold;
    opacity: 0;
    pointer-events: none;
    z-index: 1000;
    text-shadow: 0 0 30px rgba(0,0,0,0.8);
    transition: opacity 0.3s ease;
    font-family: 'Arial Black', sans-serif;
    letter-spacing: 5px;
}

.overlay-like {
    color: var(--like-color);
    border: 8px solid var(--like-color);
    padding: 30px 60px;
    border-radius: 20px;
    background: rgba(74, 222, 128, 0.1);
    backdrop-filter: blur(10px);
}

.overlay-nope {
    color: var(--nope-color);
    border: 8px solid var(--nope-color);
    padding: 30px 60px;
    border-radius: 20px;
    background: rgba(248, 113, 113, 0.1);
    backdrop-filter: blur(10px);
}

.overlay-save {
    color: var(--save-color);
    border: 8px solid var(--save-color);
    padding: 30px 60px;
    border-radius: 20px;
    background: rgba(96, 165, 250, 0.1);
    backdrop-filter: blur(10px);
}

.overlay-like.show, .overlay-nope.show, .overlay-save.show {
    opacity: 1;
}

/* Action buttons */
.action-buttons {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 25px;
    z-index: 100;
    padding: 0 20px;
    width: 100%;
    max-width: 500px;
    justify-content: center;
}

.action-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
}

.action-btn:hover {
    transform: scale(1.1);
}

.action-btn:active {
    transform: scale(0.95);
}

.btn-nope {
    background: var(--nope-color);
    color: white;
}

.btn-like {
    background: var(--like-color);
    color: white;
}

.btn-save {
    background: var(--save-color);
    color: white;
}

.btn-detail {
    background: var(--accent);
    color: var(--primary-dark);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 50px 20px;
    color: var(--text-muted);
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.empty-state-icon {
    font-size: 80px;
    margin-bottom: 20px;
    color: var(--accent);
}

/* Loading */
.loading {
    text-align: center;
    padding: 50px;
    color: var(--text-muted);
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Card stack positioning */
.swipe-card:nth-child(1) {
    z-index: 5;
    transform: scale(1);
    opacity: 1;
}

.swipe-card:nth-child(2) {
    z-index: 4;
    transform: scale(0.98) translateY(15px);
    opacity: 0.7;
    pointer-events: none;
}

.swipe-card:nth-child(3) {
    z-index: 3;
    transform: scale(0.96) translateY(30px);
    opacity: 0.5;
    pointer-events: none;
}

.swipe-card:nth-child(n+4) {
    display: none;
}

/* Back button */
.back-button {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 200;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(0,0,0,0.5);
    border: 2px solid rgba(255,255,255,0.3);
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.back-button:hover {
    background: rgba(0,0,0,0.7);
    transform: scale(1.1);
}
</style>
{% endblock %}

{% block content %}
<!-- Global Overlays -->
<div class="overlay-like">LIKE</div>
<div class="overlay-nope">NOPE</div>
<div class="overlay-save">SAVE</div>

<!-- Back Button -->
<a href="{% url 'places:discover' %}" class="back-button" title="Geri Dön">
    <i class="bi bi-arrow-left"></i>
</a>

<div class="swipe-container">
    <div class="cards-stack" id="cardsStack">
        <div class="loading">
            <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-3" style="font-size: 18px;">Mekanlar yükleniyor...</p>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons" id="actionButtons" style="display: none;">
        <button class="action-btn btn-nope" onclick="swipeCard('dislike')" title="Beğenmedim">
            <i class="bi bi-x-lg"></i>
        </button>
        <button class="action-btn btn-save" onclick="swipeCard('save')" title="Kaydet">
            <i class="bi bi-bookmark"></i>
        </button>
        <button class="action-btn btn-detail" onclick="showDetail()" title="Detay">
            <i class="bi bi-info-circle"></i>
        </button>
        <button class="action-btn btn-like" onclick="swipeCard('like')" title="Beğendim">
            <i class="bi bi-heart"></i>
        </button>
    </div>
</div>

<script>
let cards = [];
let currentIndex = 0;
let isDragging = false;
let startX = 0;
let startY = 0;
let currentX = 0;
let currentY = 0;
let currentCard = null;

// Load places
async function loadPlaces() {
    try {
        const response = await fetch('/api/places/discover/', {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success && data.places.length > 0) {
            cards = data.places;
            renderCards();
        } else {
            showEmptyState();
        }
    } catch (error) {
        console.error('Error loading places:', error);
        document.getElementById('cardsStack').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-exclamation-triangle"></i></div>
                <h4>Bir hata oluştu</h4>
                <p>Lütfen sayfayı yenileyin</p>
            </div>
        `;
    }
}

function renderCards() {
    const stack = document.getElementById('cardsStack');
    stack.innerHTML = '';
    
    // Show first 3 cards
    const cardsToShow = cards.slice(currentIndex, currentIndex + 3);
    
    if (cardsToShow.length === 0) {
        showEmptyState();
        return;
    }
    
    cardsToShow.forEach((place, index) => {
        const card = createCard(place, index);
        stack.appendChild(card);
    });
    
    // Show action buttons
    document.getElementById('actionButtons').style.display = 'flex';
    
    // Setup drag for top card
    setupDrag();
}

function createCard(place, index) {
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.dataset.placeId = place.id;
    card.style.zIndex = 5 - index;
    card.style.transform = index === 0 ? 'scale(1)' : `scale(${1 - index * 0.05}) translateY(${index * 10}px)`;
    card.style.opacity = index === 0 ? '1' : `${1 - index * 0.1}`;
    
    const photo = place.photos && place.photos.length > 0 ? place.photos[0] : null;
    const categories = place.categories || [];
    const tags = place.tags || [];
    const features = place.featured_features || [];
    
    card.innerHTML = `
        <div class="position-relative">
            ${photo ? `
                <img src="${photo}" alt="${place.name}" class="card-hero-image" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            ` : ''}
            <div class="card-hero-image" style="background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); display: ${photo ? 'none' : 'flex'}; align-items: center; justify-content: center;">
                <i class="bi bi-image" style="font-size: 80px; color: #666;"></i>
            </div>
            <div class="card-hero-overlay"></div>
            <div class="card-header">
                <h1 class="card-name" style="font-size: 42px; margin-bottom: 15px;">${place.name}</h1>
                <div class="card-category" style="font-size: 18px; margin-bottom: 10px;">
                    ${categories.slice(0, 2).join(' • ')}
                    ${place.average_rating > 0 ? ` • ${'★'.repeat(Math.floor(place.average_rating))}${'☆'.repeat(5 - Math.floor(place.average_rating))}` : ''}
                </div>
                ${place.short_description ? `<p class="card-slogan" style="font-size: 16px;">${place.short_description}</p>` : ''}
            </div>
        </div>
        <div class="card-content">
            <div class="card-tags">
                ${tags.slice(0, 4).map(tag => `<span class="card-tag">${tag}</span>`).join('')}
                ${features.slice(0, 2).map(feature => `<span class="card-tag">${feature}</span>`).join('')}
            </div>
            <div class="card-features">
                ${features.slice(0, 4).map(feature => `
                    <div class="card-feature">
                        <div class="card-feature-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="card-feature-text">
                            <div class="card-feature-title">${feature}</div>
                        </div>
                    </div>
                `).join('')}
                ${place.city ? `
                    <div class="card-feature">
                        <div class="card-feature-icon"><i class="bi bi-geo-alt-fill"></i></div>
                        <div class="card-feature-text">
                            <div class="card-feature-title">Konum</div>
                            <div class="card-feature-desc">${place.city}${place.address ? ', ' + (place.address.length > 40 ? place.address.substring(0, 40) + '...' : place.address) : ''}</div>
                        </div>
                    </div>
                ` : ''}
            </div>
            <div class="card-menu">
                <div class="card-menu-title">Menü & Fiyatlar</div>
                <div class="card-menu-items">
                    ${categories.slice(0, 4).map(cat => `
                        <div class="card-menu-item">
                            <div class="card-menu-item-name">${cat}</div>
                            <div class="card-menu-item-price">${place.price_level || '₺₺'}+</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${place.hours && Object.keys(place.hours).length > 0 ? `
                <div class="card-features" style="margin-top: 20px;">
                    <div class="card-feature">
                        <div class="card-feature-icon"><i class="bi bi-clock"></i></div>
                        <div class="card-feature-text">
                            <div class="card-feature-title">Çalışma Saatleri</div>
                            <div class="card-feature-desc">
                                ${Object.entries(place.hours).slice(0, 5).map(([day, time]) => `<strong>${day}:</strong> ${time}`).join('<br>')}
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            ${place.menu_link ? `
                <div style="margin-top: 25px; text-align: center;">
                    <a href="${place.menu_link}" target="_blank" class="btn" style="background: var(--accent); color: var(--primary-dark); padding: 15px 40px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 16px; display: inline-block;">
                        <i class="bi bi-menu-button-wide"></i> Menüyü Görüntüle
                    </a>
                </div>
            ` : ''}
            
            ${place.average_rating > 0 ? `
                <div class="card-features" style="margin-top: 25px;">
                    <div class="card-feature">
                        <div class="card-feature-icon"><i class="bi bi-star-fill" style="color: var(--accent);"></i></div>
                        <div class="card-feature-text">
                            <div class="card-feature-title">Değerlendirme</div>
                            <div class="card-feature-desc" style="font-size: 16px; margin-top: 5px;">
                                <span style="color: var(--accent); font-size: 20px;">
                                    ${'★'.repeat(Math.floor(place.average_rating))}${'☆'.repeat(5 - Math.floor(place.average_rating))}
                                </span>
                                <span style="margin-left: 10px; font-weight: bold;">${place.average_rating.toFixed(1)} / 5.0</span>
                                <span style="margin-left: 10px; color: var(--text-muted);">(${place.total_visits || 0} değerlendirme)</span>
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    return card;
}

function setupDrag() {
    const topCard = document.querySelector('.swipe-card');
    if (!topCard) return;
    
    currentCard = topCard;
    
    topCard.addEventListener('mousedown', startDrag);
    topCard.addEventListener('touchstart', startDrag, { passive: false });
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
}

function startDrag(e) {
    isDragging = true;
    currentCard.classList.add('swiping');
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    startX = clientX - currentCard.offsetLeft;
    startY = clientY - currentCard.offsetTop;
    
    e.preventDefault();
}

function drag(e) {
    if (!isDragging || !currentCard) return;
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    currentX = clientX - startX;
    currentY = clientY - startY;
    
    const rotate = currentX * 0.1;
    currentCard.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotate}deg)`;
    
    // Show overlay (global overlays)
    const overlayLike = document.querySelector('.overlay-like');
    const overlayNope = document.querySelector('.overlay-nope');
    const overlaySave = document.querySelector('.overlay-save');
    
    if (overlayLike && overlayNope && overlaySave) {
        overlayLike.classList.remove('show');
        overlayNope.classList.remove('show');
        overlaySave.classList.remove('show');
        
        if (currentX > 100) {
            overlayLike.classList.add('show');
        } else if (currentX < -100) {
            overlayNope.classList.add('show');
        } else if (currentY < -100) {
            overlaySave.classList.add('show');
        }
    }
    
    e.preventDefault();
}

function endDrag() {
    if (!isDragging || !currentCard) return;
    
    isDragging = false;
    currentCard.classList.remove('swiping');
    
    const threshold = 100;
    let action = null;
    
    if (currentX > threshold) {
        action = 'like';
    } else if (currentX < -threshold) {
        action = 'dislike';
    } else if (currentY < -threshold) {
        action = 'save';
    }
    
    if (action) {
        swipeCard(action);
    } else {
        // Snap back
        currentCard.style.transition = 'transform 0.3s ease';
        currentCard.style.transform = '';
        setTimeout(() => {
            if (currentCard) {
                currentCard.style.transition = '';
            }
        }, 300);
    }
    
    // Hide overlays
    document.querySelectorAll('.overlay-like, .overlay-nope, .overlay-save').forEach(el => {
        el.classList.remove('show');
    });
}

function swipeCard(action) {
    if (!currentCard) return;
    
    const placeId = currentCard.dataset.placeId;
    const overlay = document.querySelector(`.overlay-${action === 'dislike' ? 'nope' : action}`);
    
    if (overlay) {
        overlay.classList.add('show');
    }
    
    // Animate card out
    let translateX = 0;
    let translateY = 0;
    let rotate = 0;
    
    if (action === 'like') {
        translateX = window.innerWidth + 200;
        rotate = 30;
    } else if (action === 'dislike') {
        translateX = -window.innerWidth - 200;
        rotate = -30;
    } else if (action === 'save') {
        translateY = -window.innerHeight - 200;
    }
    
    currentCard.style.transition = 'transform 0.5s ease, opacity 0.5s ease';
    currentCard.style.transform = `translate(${translateX}px, ${translateY}px) rotate(${rotate}deg) scale(0.8)`;
    currentCard.style.opacity = '0';
    
    // Send to API
    sendSwipeAction(placeId, action);
    
    // Hide overlay after animation
    setTimeout(() => {
        document.querySelectorAll('.overlay-like, .overlay-nope, .overlay-save').forEach(el => {
            el.classList.remove('show');
        });
    }, 300);
    
    // Remove card and show next
    setTimeout(() => {
        if (currentCard && currentCard.parentNode) {
            currentCard.remove();
        }
        currentIndex++;
        renderCards();
    }, 500);
}

async function sendSwipeAction(placeId, action) {
    try {
        const response = await fetch('/api/places/discover/swipe/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                place_id: parseInt(placeId),
                action: action,
                timestamp: new Date().toISOString()
            })
        });
        
        const data = await response.json();
        if (data.success) {
            console.log(`✓ ${action} action saved`);
        }
    } catch (error) {
        console.error('Error sending swipe action:', error);
    }
}

function showDetail() {
    const topCard = document.querySelector('.swipe-card');
    if (!topCard) return;
    
    const placeId = topCard.dataset.placeId;
    window.location.href = `/places/${placeId}/`;
}

function showEmptyState() {
    document.getElementById('cardsStack').innerHTML = `
        <div class="empty-state" style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div class="empty-state-icon"><i class="bi bi-check-circle-fill" style="font-size: 80px; color: var(--accent);"></i></div>
            <h2 style="color: var(--text-light); margin-top: 30px; margin-bottom: 15px;">Tüm mekanları gördün!</h2>
            <p style="color: var(--text-muted); font-size: 18px; margin-bottom: 30px;">Daha fazla mekan için filtreleri değiştirebilirsin</p>
            <a href="/discover/" class="btn mt-3" style="background: var(--accent); color: var(--primary-dark); padding: 15px 40px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 16px;">
                <i class="bi bi-compass"></i> Keşfet Sayfasına Dön
            </a>
        </div>
    `;
    document.getElementById('actionButtons').style.display = 'none';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load places on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPlaces();
});
</script>
{% endblock %}
